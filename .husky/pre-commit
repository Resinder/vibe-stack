#!/usr/bin/env sh
# =============================================================================
# Vibe Stack - Pre-Commit Hook
# =============================================================================
#
# This script runs before each commit to ensure code quality.
# It performs:
# - Shell script linting (shellcheck)
# - YAML syntax validation (docker-compose*.yml)
# - JSON syntax validation (package.json, .env.example)
# - Fast tests (< 30 seconds)
# - Checks for committed secrets
# - Trims trailing whitespace
#
# To skip this hook (not recommended):
#   git commit --no-verify -m "commit message"
#
# =============================================================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "Running pre-commit checks..."

# =============================================================================
# 1. Check for committed secrets
# =============================================================================
echo "Checking for committed secrets..."

if git diff --cached --name-only | grep -E "\.(env|pem|key|secret|password)$"; then
    echo "${YELLOW}[WARN]${NC} Possible secret files staged for commit"
    echo "  If these are template files, rename them to *.example"
    read -p "  Continue anyway? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "${RED}[ERROR]${NC} Commit aborted"
        exit 1
    fi
fi

# =============================================================================
# 2. Validate YAML syntax
# =============================================================================
echo "Validating YAML files..."

for yaml_file in $(git diff --cached --name-only | grep -E '\.(yml|yaml)$'); do
    if command -v yamllint &> /dev/null; then
        if ! yamllint -d "{extends: default, rules: {line-length: {max: 120}}}" "$yaml_file"; then
            echo "${RED}[ERROR]${NC} YAML validation failed for $yaml_file"
            exit 1
        fi
    else
        echo "  yamllint not found, skipping YAML validation"
    fi
done

echo "${GREEN}[✓]${NC} YAML validation passed"

# =============================================================================
# 3. Validate JSON syntax
# =============================================================================
echo "Validating JSON files..."

for json_file in $(git diff --cached --name-only | grep -E '\.json$'); do
    if command -v jq &> /dev/null; then
        if ! jq empty "$json_file" 2>/dev/null; then
            echo "${RED}[ERROR]${NC} JSON validation failed for $json_file"
            exit 1
        fi
    else
        # Fallback: python
        if command -v python &> /dev/null; then
            if ! python -m json.tool "$json_file" > /dev/null 2>&1; then
                echo "${RED}[ERROR]${NC} JSON validation failed for $json_file"
                exit 1
            fi
        fi
    fi
done

echo "${GREEN}[✓]${NC} JSON validation passed"

# =============================================================================
# 4. Lint shell scripts
# =============================================================================
echo "Linting shell scripts..."

for shell_file in $(git diff --cached --name-only | grep -E '\.(sh|bash)$'); do
    if command -v shellcheck &> /dev/null; then
        if ! shellcheck -x "$shell_file"; then
            echo "${RED}[ERROR]${NC} Shellcheck failed for $shell_file"
            echo "  Fix issues or skip with --no-verify"
            exit 1
        fi
    else
        echo "  shellcheck not found, skipping shell script linting"
    fi
done

echo "${GREEN}[✓]${NC} Shell script linting passed"

# =============================================================================
# 5. Check file sizes
# =============================================================================
echo "Checking file sizes..."

for file in $(git diff --cached --name-only); do
    if [ -f "$file" ]; then
        size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null)
        # Warn for files > 5MB
        if [ "$size" -gt 5242880 ]; then
            echo "${YELLOW}[WARN]${NC} Large file staged: $file ($(( size / 1024 / 1024 ))MB)"
            echo "  Consider using Git LFS for large files"
        fi
    fi
done

echo "${GREEN}[✓]${NC} File size check passed"

# =============================================================================
# 6. Check line endings
# =============================================================================
echo "Checking line endings..."

for file in $(git diff --cached --name-only | grep -E '\.(sh|js|yml|yaml|json|md)$'); do
    if [ -f "$file" ]; then
        if file "$file" | grep -q CRLF; then
            echo "${YELLOW}[WARN]${NC} $file has CRLF line endings"
            echo "  Consider converting to LF for consistency"
        fi
    fi
done

echo "${GREEN}[✓]${NC} Line ending check passed"

# =============================================================================
# 7. Trim trailing whitespace
# =============================================================================
echo "Trimming trailing whitespace..."

for file in $(git diff --cached --name-only | grep -E '\.(sh|js|yml|yaml|json|md)$'); do
    if [ -f "$file" ]; then
        # Trim trailing whitespace and add back to staging
        sed -i 's/[[:space:]]*$//' "$file"
        git add "$file" 2>/dev/null || true
    fi
done

echo "${GREEN}[✓]${NC} Trailing whitespace trimmed"

# =============================================================================
# 8. Run fast tests
# =============================================================================
echo "Running fast tests..."

# Check if tests are enabled in package.json
if npm run test:fast 2>/dev/null; then
    echo "${GREEN}[✓]${NC} Fast tests passed"
else
    echo "  No fast test script found, skipping"
fi

# =============================================================================
# All checks passed
# =============================================================================
echo ""
echo "${GREEN}[SUCCESS]${NC} All pre-commit checks passed!"
echo ""
