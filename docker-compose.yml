# ============================================================================
# Vibe Stack - Docker Compose Configuration
# ============================================================================
# Production-ready Docker orchestration for 4 services:
#   - Vibe-Kanban: AI agent orchestration platform (port 4000)
#   - code-server: Browser-based VS Code (port 8443)
#   - Open WebUI: AI chat interface for task planning (port 8081)
#   - MCP Server: API bridge with 10 tools (port 4001)
#
# Compose Specification: V2 (version key deprecated/omitted)
# Image Strategy: :latest tags with enhanced health monitoring
# Documentation: See README.md and docs/HELPER.md
# ============================================================================

services:
  # ============================================================================
  # VIBE-KANBAN SERVICE (AI Agent Orchestration)
  # ============================================================================
  # External project: https://github.com/BloopAI/vibe-kanban
  # Cloned to: ./repos/vibe-kanban
  # Update: cd repos/vibe-kanban && git pull
  vibe-kanban:
    build:
      context: ./repos/vibe-kanban
      dockerfile: Dockerfile
      args:
        POSTHOG_API_KEY: ${POSTHOG_API_KEY:-}
        POSTHOG_API_ENDPOINT: ${POSTHOG_API_ENDPOINT:-}
    image: vibe-kanban:1.1.12
    container_name: vibe-kanban
    restart: unless-stopped

    # Network ports (vibe-kanban uses port 3000 by default)
    ports:
      - "4000:3000"      # Map host 4000 to container 3000
      - "3000-3100:3000-3100"  # Dev server port range for projects

    # Environment variables
    environment:
      - HOST=0.0.0.0
      - PORT=3000
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER:-vibeuser}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-vibepass}
      - POSTGRES_DB=${POSTGRES_DB:-vibestack}
      - VIBE_BOARD_DEFAULT_FILE=/data/.vibe-kanban-board.json

    # Volume mounts
    volumes:
      # Vibe-Kanban data persistence
      - vibe_config:/data
      - vibe_data:/repos

      # Workspace directory for projects
      - ./repos:/repos

      # SSH keys (read-only) for git operations
      - ~/.ssh:/root/.ssh:ro

      # Project secrets (read-only, isolated from agent)
      - ./secrets:/root/secrets:ro

    # Health check - verifies Vibe-Kanban is responding
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Resource constraints (vibe-kanban is Rust + Node frontend, needs more resources)
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G

    # Dependency on PostgreSQL
    depends_on:
      postgres:
        condition: service_healthy

  # ============================================================================
  # CODE-SERVER SERVICE (Browser-based VS Code)
  # ============================================================================
  code-server:
    # VS Code in browser
    # Using pinned version for security
    # Reference: https://github.com/linuxserver/docker-code-server
    image: lscr.io/linuxserver/code-server:25.1.1
    container_name: code-server

    # Network ports (linuxserver/code-server uses port 8443 internally)
    ports:
      - "8443:8443"

    # Environment variables
    environment:
      - PASSWORD=${CODE_SERVER_PASSWORD:-dev123}
      - DOCKER_USER=root
      - DEFAULT_WORKSPACE=/home/coder/repos

    # Volume mounts
    volumes:
      # Shared workspace (same as vibe-kanban)
      - ./repos:/home/coder/repos

      # User data persistence (settings, extensions, etc.)
      - code_server_data:/home/coder

      # SSH keys (read-only) for git operations
      - ~/.ssh:/home/coder/.ssh:ro

    # Health check - verifies code-server is responding
    # Note: /health endpoint requires auth, so we check root endpoint instead
    # Reference: https://github.com/coder/code-server/issues/5461
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8443/"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 30s

    # Resource constraints (lightweight IDE usage)
    deploy:
      resources:
        limits:
          cpus: '1.0'      # Maximum 1 CPU core
          memory: 1G       # Maximum 1GB RAM
        reservations:
          cpus: '0.25'     # Minimum 0.25 CPU cores
          memory: 256M     # Minimum 256MB RAM

    # Restart policy
    restart: unless-stopped

    # Development mode configuration (hot-reload for code-server)
    develop:
      watch:
        - path: ./repos
          action: sync
          target: /home/coder/repos
          ignore:
            - node_modules/
            - .git/

  # ============================================================================
  # OPEN WEBUI SERVICE (AI Model Interface)
  # ============================================================================
  open-webui:
    # AI chat interface - v0.7.2 (latest)
    # Pinned for stability - auto-updated via Renovate
    # Supports: OpenAI, Anthropic, Google, Ollama (local), and custom endpoints
    # Reference: https://github.com/open-webui/open-webui
    image: ghcr.io/open-webui/open-webui:v0.7.2
    container_name: open-webui

    # Network ports (moved to 8081 to avoid conflicts)
    # Note: Original port 3000 conflicts with other dev servers
    ports:
      - "8081:8080"

    # Environment variables
    environment:
      - ENABLE_OLLAMA_API=false
      - DATA_DIR=/app/backend/data
      - MODELS=

    # Volume mounts
    volumes:
      # Open WebUI data (models, chats, settings)
      - open_webui_data:/app/backend/data

      # Optional: Mount models directory for local LLM support
      # - ./models:/app/models

    # Health check - verifies Open WebUI is responding
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    # Resource constraints (lightweight for UI; increase for local models)
    deploy:
      resources:
        limits:
          cpus: '1.0'      # Maximum 1 CPU core (increase for local LLMs)
          memory: 1G       # Maximum 1GB RAM (increase for local LLMs)
        reservations:
          cpus: '0.25'     # Minimum 0.25 CPU cores
          memory: 256M     # Minimum 256MB RAM

    # Restart policy
    restart: unless-stopped

    # Dependency on code-server (optional, for workspace consistency)
    depends_on:
      code-server:
        condition: service_healthy

  # ============================================================================
  # MCP SERVER (Open WebUI Integration)
  # ============================================================================
  mcp-server:
    # Enhanced Model Context Protocol server for Vibe Stack integration
    # Features: intelligent planning, real-time sync, webhook support
    # Multi-stage build: base -> dependencies -> production
    container_name: vibe-mcp-server
    build:
      context: ./mcp-server
      dockerfile: Dockerfile
      target: production

    # Network ports
    ports:
      - "4001:4001"  # HTTP Proxy API

    # Environment variables
    environment:
      - BRIDGE_FILE=/data/.vibe-kanban-bridge.json
      - HTTP_PORT=4001
      - NODE_ENV=production
      # PostgreSQL connection
      - PGHOST=postgres
      - PGPORT=5432
      - PGDATABASE=${POSTGRES_DB:-vibestack}
      - PGUSER=${POSTGRES_USER:-vibeuser}
      - PGPASSWORD=${POSTGRES_PASSWORD:-vibepass}
      # Credential encryption (REQUIRED in production)
      # Set in .env file: CREDENTIAL_ENCRYPTION_KEY=$(openssl rand -base64 48)
      - CREDENTIAL_ENCRYPTION_KEY=${CREDENTIAL_ENCRYPTION_KEY}

    # Volume mounts
    volumes:
      # Mount bridge file for board state (read-write for updates)
      - ./.vibe-kanban-bridge.json:/data/.vibe-kanban-bridge.json
      # Mount custom panel for Open WebUI
      - ./services/open-webui-custom:/custom:ro

    # Health check
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Resource constraints
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

    # Restart policy
    restart: unless-stopped

    # Dependencies
    depends_on:
      vibe-kanban:
        condition: service_healthy
      postgres:
        condition: service_healthy

  # ============================================================================
  # POSTGRESQL DATABASE (For state management and persistence)
  # ============================================================================
  postgres:
    # PostgreSQL 18.1 - Alpine Linux for minimal footprint
    # Pinned for stability - auto-updated via Renovate
    image: postgres:18.1-alpine
    container_name: vibe-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=vibestack
      - POSTGRES_USER=vibeuser
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-vibepass}
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/docker/postgres-init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-vibeuser} -d ${POSTGRES_DB:-vibestack}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

# ============================================================================
# PERSISTENT VOLUMES
# ============================================================================
volumes:
  # Vibe-Kanban configuration (settings, preferences)
  vibe_config:
    driver: local

  # Vibe-Kanban data (SQLite database, projects)
  vibe_data:
    driver: local

  # code-server user data (VS Code settings, extensions)
  code_server_data:
    driver: local

  # Open WebUI data (chats, models, settings)
  open_webui_data:
    driver: local

  # PostgreSQL data (for state management and persistence)
  postgres_data:
    driver: local

# ============================================================================
# NETWORKS
# ============================================================================
networks:
  default:
    name: vibe-network
    driver: bridge
