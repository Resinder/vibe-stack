<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vibe Kanban Panel</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-primary: #1a1a2e;
      --bg-secondary: #16213e;
      --bg-tertiary: #0f3460;
      --text-primary: #eaeaea;
      --text-secondary: #a0a0a0;
      --accent: #e94560;
      --success: #4ade80;
      --warning: #fbbf24;
      --danger: #ef4444;
      --border: #374151;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      padding: 20px;
    }

    .panel {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border);
    }

    .header h1 {
      font-size: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 15px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent);
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 5px;
    }

    .board {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 15px;
      overflow-x: auto;
    }

    .lane {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 15px;
      min-width: 250px;
    }

    .lane-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }

    .lane-title {
      font-weight: 600;
      font-size: 14px;
    }

    .lane-count {
      background: var(--bg-tertiary);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
    }

    .task {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .task:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .task-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 5px;
    }

    .task-meta {
      display: flex;
      gap: 10px;
      font-size: 11px;
      color: var(--text-secondary);
    }

    .priority-high { border-left: 3px solid var(--danger); }
    .priority-medium { border-left: 3px solid var(--warning); }
    .priority-low { border-left: 3px solid var(--success); }
    .priority-critical { border-left: 3px solid #ff0080; }

    .ai-badge {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
    }

    .actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: #d63450;
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .empty-lane {
      text-align: center;
      padding: 30px;
      color: var(--text-secondary);
      font-size: 13px;
    }

    @media (max-width: 1200px) {
      .board {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 768px) {
      .board {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="panel">
    <div class="header">
      <h1>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 3h18v18H3zM9 3v18M15 3v18M3 9h18M3 15h18"/>
        </svg>
        Vibe Kanban
      </h1>
      <button class="btn btn-primary" onclick="refreshBoard()">Refresh</button>
    </div>

    <div class="stats" id="stats"></div>

    <div class="board" id="board"></div>
  </div>

  <script>
    const API_BASE = 'http://localhost:4001';
    let currentBoard = null;

    async function fetchBoard() {
      try {
        const response = await fetch(`${API_BASE}/.vibe-kanban-bridge.json?t=${Date.now()}`);
        currentBoard = await response.json();
        renderBoard();
        renderStats();
      } catch (error) {
        console.error('Failed to fetch board:', error);
      }
    }

    function renderStats() {
      if (!currentBoard) return;

      const stats = {
        total: 0,
        byLane: {},
        byPriority: { high: 0, medium: 0, low: 0, critical: 0 },
        totalHours: 0
      };

      for (const [lane, tasks] of Object.entries(currentBoard.lanes)) {
        stats.byLane[lane] = tasks.length;
        stats.total += tasks.length;

        for (const task of tasks) {
          const priority = task.priority || 'medium';
          stats.byPriority[priority]++;
          stats.totalHours += task.estimatedHours || 0;
        }
      }

      document.getElementById('stats').innerHTML = `
        <div class="stat-card">
          <div class="stat-value">${stats.total}</div>
          <div class="stat-label">Total Tasks</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${stats.byLane.in_progress || 0}</div>
          <div class="stat-label">In Progress</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${stats.byLane.done || 0}</div>
          <div class="stat-label">Completed</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${stats.totalHours}h</div>
          <div class="stat-label">Estimated</div>
        </div>
      `;
    }

    function renderBoard() {
      if (!currentBoard) return;

      const lanes = ['backlog', 'todo', 'in_progress', 'done', 'recovery'];
      const laneNames = {
        backlog: 'Backlog',
        todo: 'To Do',
        in_progress: 'In Progress',
        done: 'Done',
        recovery: 'Recovery'
      };

      document.getElementById('board').innerHTML = lanes.map(lane => {
        const tasks = currentBoard.lanes[lane] || [];
        return `
          <div class="lane">
            <div class="lane-header">
              <span class="lane-title">${laneNames[lane]}</span>
              <span class="lane-count">${tasks.length}</span>
            </div>
            ${tasks.length === 0
              ? '<div class="empty-lane">No tasks</div>'
              : tasks.map(task => renderTask(task)).join('')
            }
          </div>
        `;
      }).join('');
    }

    function renderTask(task) {
      const priorityClass = `priority-${task.priority || 'medium'}`;
      const hasAIBadge = task.tags?.includes('ai-generated');

      return `
        <div class="task ${priorityClass}" onclick="openTask('${task.id}')">
          <div class="task-title">
            ${task.title}
            ${hasAIBadge ? '<span class="ai-badge">AI</span>' : ''}
          </div>
          ${task.description ? `<div style="font-size:11px;color:var(--text-secondary);margin:5px 0;">${task.description.substring(0, 60)}...</div>` : ''}
          <div class="task-meta">
            <span>${task.estimatedHours || 0}h</span>
            <span>${task.priority || 'medium'}</span>
          </div>
        </div>
      `;
    }

    function openTask(taskId) {
      // Open task in Vibe Kanban
      window.open(`http://localhost:4000?task=${taskId}`, '_blank');
    }

    function refreshBoard() {
      fetchBoard();
    }

    // Auto-refresh every 10 seconds
    setInterval(fetchBoard, 10000);

    // Initial load
    fetchBoard();
  </script>
</body>
</html>
